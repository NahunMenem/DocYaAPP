{% extends "base.html" %}
{% block title %}Médicos Registrados | DocYa{% endblock %}

{% block head_scripts %}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDnaoExuqJAcquC_joiPZA1lGDdhRHV4wY&libraries=places"></script>
{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-6 flex items-center gap-2 text-primary">
    <i data-lucide="users" class="w-6 h-6"></i> Médicos Registrados
</h1>

{% if medicos %}
<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for m in medicos %}
    <div class="bg-white rounded-xl shadow-lg p-5 border hover:shadow-xl transition">
        <div class="flex items-center gap-3 mb-3">
            <div class="bg-primary text-white rounded-full w-12 h-12 flex items-center justify-center font-bold text-lg">
                {{ m.nombre[0] }}{{ m.apellido[0] }}
            </div>
            <div>
                <h2 class="text-lg font-semibold">{{ m.nombre }} {{ m.apellido }}</h2>
                <p class="text-sm text-gray-500">Matrícula: {{ m.matricula }}</p>
                <p class="flex items-center gap-1 text-sm font-medium
                    {% if m.profesion|trim|lower|replace('é','e') == 'medico' %}
                        text-green-600
                    {% else %}
                        text-blue-600
                    {% endif %}">
                    {% if m.profesion == 'Medico' %}
                        <i data-lucide="stethoscope" class="w-4 h-4"></i> Médico
                    {% else %}
                        <i data-lucide="syringe" class="w-4 h-4"></i> Enfermero
                    {% endif %}

                </p>

            </div>
        </div>

        <div class="space-y-1 text-sm text-gray-600">
            <p><i data-lucide="id-card" class="inline w-4 h-4 text-primary"></i> DNI: {{ m.dni }}</p>
            <p><i data-lucide="phone" class="inline w-4 h-4 text-primary"></i> {{ m.telefono }}</p>
            <p><i data-lucide="mail" class="inline w-4 h-4 text-primary"></i> {{ m.email }}</p>
            <p><i data-lucide="banknote" class="inline w-4 h-4 text-primary"></i> {{ m.cbu_alias }}</p>
            <p><i data-lucide="map-pin" class="inline w-4 h-4 text-primary"></i> {{ m.direccion }}</p>
        </div>

        <!-- Puntuación -->
        <div class="flex items-center mt-3">
            {% set estrellas_llenas = m.puntuacion|int %}
            {% set media_estrella = 1 if (m.puntuacion - estrellas_llenas) >= 0.5 else 0 %}
            {% set estrellas_vacias = 5 - estrellas_llenas - media_estrella %}

            {% for i in range(estrellas_llenas) %}
                <i data-lucide="star" class="w-4 h-4 text-yellow-400 fill-yellow-400"></i>
            {% endfor %}
            {% if media_estrella %}
                <i data-lucide="star-half" class="w-4 h-4 text-yellow-400 fill-yellow-400"></i>
            {% endif %}
            {% for i in range(estrellas_vacias) %}
                <i data-lucide="star" class="w-4 h-4 text-gray-300"></i>
            {% endfor %}
            <span class="ml-1 text-sm text-gray-500">({{ m.puntuacion|round(1) }})</span>
        </div>

        <!-- Formulario para editar puntuación -->
        <form method="POST" action="{{ url_for('actualizar_puntuacion', medico_id=m.id) }}" class="mt-2 flex items-center gap-2">
            <input type="number" name="puntuacion" min="0" max="5" step="0.5"
                   value="{{ m.puntuacion }}" class="w-16 p-1 border rounded text-center">
            <button type="submit" class="bg-primary text-white px-3 py-1 rounded hover:bg-blue-600 flex items-center gap-1">
                <i data-lucide="save" class="w-4 h-4"></i> Guardar
            </button>
        </form>

        <!-- Mapa mini -->
        <div id="map-{{ m.id }}" class="mt-3 rounded-lg border" style="height: 150px;"></div>
        <script>
            function initMap{{ m.id }}() {
                const coords = { lat: parseFloat("{{ m.latitud or -34.6037 }}"), lng: parseFloat("{{ m.longitud or -58.3816 }}") };
                const map = new google.maps.Map(document.getElementById("map-{{ m.id }}"), {
                    center: coords,
                    zoom: 14
                });
                new google.maps.Marker({ position: coords, map: map });
            }
            google.maps.event.addDomListener(window, "load", initMap{{ m.id }}); 
        </script>
    </div>
    {% endfor %}
</div>
{% else %}
<p class="text-gray-500">No hay médicos registrados.</p>
{% endif %}
{% endblock %}
